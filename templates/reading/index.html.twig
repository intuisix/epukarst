{% extends 'base.html.twig' %}

{% form_theme form _self %}

{% block title %}
    Relevés
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>
{% endblock %}

{% block body %}
    <div class="row no-gutters">
        <div class="col-md-3 no-gutters">
            {# Conteneur pour les filtres #}
            <div class="container">
                {{form_start(form)}}

                {{form_row(form.systems)}}

                {{form_row(form.basins)}}

                {# {{form_row(form.stations)}} #}

                <div class="row">
                    <div class="col">
                        {{form_label(form.minimumDate)}}
                        {{form_errors(form.minimumDate)}}
                        {{form_widget(form.minimumDate)}}
                        {{form_help(form.minimumDate)}}
                    </div>
                    <div class="col">
                        {{form_label(form.maximumDate)}}
                        {{form_errors(form.maximumDate)}}
                        {{form_widget(form.maximumDate)}}
                        {{form_help(form.maximumDate)}}
                    </div>
                </div>

                <div class="row my-3">
                    <div class="col">
                        {# Bouton pour appliquer le filtre #}
                        <button type="submit" class="btn btn-success float-right">
                            <i class="fas fa-filter"></i>
                            Filtrer les relevés
                        </button>
                    </div>
                </div>

                {{form_end(form)}}
            </div>
        </div>
        <div class="col no-gutters">
            {# Conteneur pour la carte des relevés #}
            <div class="container">
                <div id="map" style="height: 400px">Carte</div>
            </div>

            {# Conteneur pour la liste des relevés #}
            <div class="container">
                <table width="100%" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th><input type="checkbox" name="" id=""/></th>
                            <th>Date et heure</th>
                            <th>Code</th>
                            <th>Système</th>
                            <th>Bassin</th>
                            <th>Station</th>
                            {% for parameter in parameters %}
                                <th style="text-align: center">{{parameter.name}}</th>
                            {% endfor %}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reading in pagination.data %}
                            <tr>
                                <th><input type="checkbox" name="" id=""/></th>
                                <td>{{reading.fieldDateTime|date('d/m/Y H:i')}}</td>
                                <td><a href="{{ path('reading_show', { 'code': reading.code }) }}">{{reading.code}}</a></td>
                                <td>{{reading.station.basin.system.name}}</td>
                                <td>{{reading.station.basin.name}}</td>
                                <td>{{reading.station.name}}</td>
                                {% for parameter in parameters %}
                                    <td style="text-align: right">
                                        {% set avg = reading.average(parameter) %}
                                        {% if avg is not null %}
                                            {{avg|format_number({fraction_digit: 3})}}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td>
                                    <a href="{{ path('reading_modify', {'code': reading.code}) }}" class="text-primary"><i class="fas fa-edit"></i></a>
                                    <a href="#" class="text-danger"><i class="fas fa-trash"></i></a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {{pagination.display}}

                <a class="btn btn-primary mb-3" href="{{ path('reading_encode') }}" role="button">Encoder un nouveau relevé</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
    integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
    crossorigin=""></script>

    <script>
        var mymap = L.map('map').setView([50.200, 4.8667], 8);

{% if 0 %}
{# Cette branche doit être réactivée et complétée avec les clés d'API à demander à MapBox (ou un autre fournisseur) #}
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: 'your.mapbox.access.token'
        }).addTo(mymap);
{% else %}
    /* TODO: This is temporary code, which will be replaced with the correcly licensed maps. */
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);
{% endif %}
    </script>

    <script>
        /* Find the systems filter */
        var $systems = $('#filter_systems');
        /* When a system gets selected or deselected: */
        $systems.change(function() {
            /* Find the form which the systems filter belongs to */
            var $form = $(this).closest('form');
            /* Simulate form data, but only include the selected systems value */
            var data = {};
            data['filter[systems]'] = $systems.find('input[type=checkbox]:checked').map(function(index, item) { return $(item).val() }).get();
            /* Submit data via AJAX to the form's action path */
            $.ajax({
                url: $form.attr('action'),
                type: $form.attr('method'),
                data: data,
                success: function(html) {
                    /* Replace the current basins field... */
                    $('#filter_basins').replaceWith(
                        /* ...with the returned one from the AJAX response */
                        $(html).find('#filter_basins')
                    );
                    /* The basins field now displays the filtered items */
                }
            });
        });
    </script>
{% endblock %}
