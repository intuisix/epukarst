{#
Template pour l'affichage du formulaire d'encodage ou de validation d'un
relevé de système.

Attention: chaque fois que l'on affiche la liste des paramètre, il faut
utiliser la liste ordonnée donnée par le contrôleur comme 'systemParameters'.
Cette liste est en effet consistante avec l'ordre dans lequel le contrôleur a
créé les mesures. Il ne faut pas absolument pas utiliser la liste du système,
car celle-ci n'est pas triée.
#}

{% extends 'base.html.twig' %}

{% block title %}
    {{title}}
{% endblock %}

{% form_theme form _self %}

{% block body %}
    <div class="mx-3 my-3">
        <h1>{{title}}</h1>

        <p>Ce formulaire permet l'encodage rapide des mesures pour toutes les stations d'un système, en leur attribuant la même date de terrain et les mêmes instruments de mesure. Avant de commencer, vérifiez ci-dessous si la liste des stations et la liste des paramètres sont complètes, et adaptez-les en cas de besoin&nbsp;!</p>

        {{form_start(form)}}

        {# Informations générales #}
        <div class="alert bg-light">
            <div class="row">
                <div class="col-2">
                    {# Date et heure de terrain #}
                    {{form_row(form.fieldDateTime)}}
                </div>
                <div class="col-2">
                    {# Code du relevé de système #}
                    {{form_row(form.code)}}
                </div>
                <div class="col">
                    {# Sélection de l'alarme #}
                    {{form_row(form.alarm)}}
                </div>
                <div class="col-4">
                    <a href="{{path('system_station', {'code': system.code})}}" class="btn btn-primary btn-block">
                        <i class="fas fa-bullseye"></i>
                        Définir les stations du système
                    </a>
                    <a href="{{path('system_parameter', {'code': system.code})}}" class="btn btn-primary btn-block">
                        <i class="fas fa-asterisk"></i>
                        Définir les paramètres du système
                    </a>
                </div>
            </div>
        </div>

        {# Valeurs de contrôles #}
        {% if form.controls|length %}
            <div class="alert bg-light">
                <h4>Mesures de contrôle</h4>
                <table cellpadding="3" width="100%">
                    <thead>
                        <tr>
                            <td width="20%">&nbsp;</td>
                            {% for systemParameter in systemParameters %}
                                <td class="text-center">
                                    {# Nom du paramètre #}
                                    <strong>
                                        {{systemParameter.instrumentParameter.parameter.name}}
                                    </strong>
                                    <br>
                                    {# Unité du paramètre #}
                                    {{systemParameter.instrumentParameter.parameter.unit}}
                                </td>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Valeur</td>
                            {{form_widget(form.controls)}}
                        </tr>
                    </tbody>
                </table>
            </div>
        {% endif %}

        {# Relevés de stations #}
        {% if form.stationReadings|length == 0 %}
            <div class="alert alert-warning">
                Pour pouvoir encoder des mesures, vous devez d'abord assigner des stations et des paramètres au système.
            </div>
            {{form_widget(form.stationReadings)}}
        {% else %}
            <div class="alert bg-light">
                <h4>Mesures aux stations</h4>
                {# Tableau d'encodage des mesures avec en colonnes les paramètres, en lignes les stations, et en cellules les mesures #}
                <table cellpadding="3" width="100%">
                    <thead>
                        <tr>
                            <td width="20%">&nbsp;</td>
                            {% for systemParameter in systemParameters %}
                                <td class="text-center">
                                    {# Nom du paramètre #}
                                    <strong>
                                        {{systemParameter.instrumentParameter.parameter.name}}
                                    </strong>

                                    <br>
                                    {# Unité du paramètre #}
                                    {% if systemParameter.instrumentParameter.inputConversion is not null and conversions_enabled %}
                                        {# Avec conversion #}
                                        {{systemParameter.instrumentParameter.inputUnit}}
                                        {# Icône de conversion #}
                                        <i class="fas fa-square-root-alt" data-toggle="tooltip" data-placement="top" data-html="true" title="La valeur sera convertie automatiquement&nbsp;:<br>y={{systemParameter.instrumentParameter.inputConversion|default('x')}}"></i>
                                    {% else %}
                                        {# Avec conversion #}
                                        {{systemParameter.instrumentParameter.parameter.unit}}
                                    {% endif %}
                                    <br>
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td>Instrument</td>
                            {% for systemParameter in systemParameters %}
                                <td class="text-center">
                                    {# Nom de l'instrument #}
                                    {{systemParameter.instrumentParameter.instrument.name}}
                                </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td>Valeurs normatives</td>
                            {% for systemParameter in systemParameters %}
                                <td class="text-center">
                                    {# Minimum normatif #}
                                    {{systemParameter.instrumentParameter.parameter.normativeMinimum}}
                                    -
                                    {# Maximum normatif #}
                                    {{systemParameter.instrumentParameter.parameter.normativeMaximum}}
                                </td>
                            {% endfor %}
                        </tr>
                    </thead>
                    {# Relevés de stations #}
                    {{form_widget(form.stationReadings)}}
                </table>
                <small class="text-muted">Introduisez <strong>toutes</strong> les valeurs qui ont été mesurées, en veillant à respecter l'unité du paramètre concerné&nbsp;.<br>Décochez &laquo;&nbsp;S&nbsp;&raquo; si la valeur était instable lors de la mesure, et &laquo;&nbsp;V&nbsp;&raquo; si une valeur invalide (p.ex. elle est hors gamme, ou l'instrument n'est pas en ordre d'étalonnage).</small>
            </div>

            <div class="alert bg-light">
                <h4>Remarques</h4>
                <table cellpadding="3" width="100%">
                    <thead>
                        <tr>
                            <th width="20%">Station</th>
                            <th>Remarque</th>
                        </tr>
                    </thead>
                    {% for stationReading in form.children.stationReadings %}
                        <tbody>
                            <tr>
                                <td class="align-top">
                                    {{stationReading.vars.data.station.name}}
                                    <br>
                                    <small>
                                        <span class="badge badge-secondary">
                                            {{stationReading.vars.value.station.code}}
                                        </span>
                                        {{stationReading.vars.value.station.atlasCode}}
                                    </small>
                                </td>
                                <td>
                                    {{form_widget(stationReading.children.encodingNotes, {
                                        'attr' : {'rows': 1}
                                    })}}
                                </td>
                            </tr>
                        </tbody>
                    {% endfor %}
                </table>
            </div>
        {% endif %}

        {# Informations d'encodage #}
        {% if form.encodingNotes is defined %}
            <div class="alert bg-light">
                <div class="row">
                    <div class="col-3">
                        {{form_row(form.encodingDateTime)}}
                        {{form_row(form.encodingAuthor)}}
                    </div>
                    <div class="col">
                        {{form_row(form.encodingNotes, {
                            'attr': {'rows': 4}})}}
                    </div>
                </div>
            </div>
        {% endif %}

        {# Informations de validation #}
        {% if form.validationNotes is defined %}
            <div class="alert bg-light">
                <div class="row">
                    <div class="col-3">
                        {{form_row(form.validationDateTime)}}
                        {{form_row(form.validationAuthor)}}
                    </div>
                    <div class="col">
                        {{form_row(form.validationNotes, {
                            'attr': {'rows': 4}})}}
                        {{form_row(form.validationStatus)}}
                    </div>
                </div>
            </div>
        {% endif %}

        {# Bouton permettant d'enregistrer le relevé #}
        <button type="submit" class="btn btn-success">
            <i class="fas fa-check"></i>
            Enregistrer le relevé
        </button>
        {# Bouton permettant de revenir à la page précédente #}
        {% include '_back.html.twig' %}

        {{form_end(form)}}
    </div>
{% endblock %}

{# Modèle d'une valeur de contrôle #}
{% block _system_reading_controls_entry_row %}
    <td>
        {{form_widget(form.value)}}
    </td>
{% endblock %}

{# Modèle d'un relevé de station #}
{% block _system_reading_stationReadings_entry_row %}
    <tbody id="{{id}}">
        <tr>
            {# Cellules statiques relatives à la station #}
            <td class="align-top">
                {{form.vars.value.station.name}}
                <br>
                <small>
                    <span class="badge badge-secondary">
                        {{form.vars.value.station.code}}
                    </span>
                    {{form.vars.value.station.atlasCode}}
                </small>
            </td>

            {# Mesures du relevé de station #}
            {{form_widget(form.measures)}}
        </tr>
    </tbody>
{% endblock %}

{# Modèle d'une mesure #}
{% block _system_reading_stationReadings_entry_measures_entry_row %}
    <td class="align-top">
        {# Inclure le widget de paramètre (caché) #}
        {{form_widget(form.measurability)}}
        {# Afficher le widget de valeur et l'éventuelle erreur #}
        {{form_errors(form.value)}}
        {{form_widget(form.value)}}
        {# Afficher la case à cocher de mesure stable #}
        {{form_widget(form.stable, {
            'label_attr': {
                'class': 'checkbox-inline',
                'style': 'color: lightgray',
            }
        })}}
        {# Afficher la case à cocher de mesure valide #}
        {{form_widget(form.valid, {
            'label_attr': {
                'class': 'checkbox-inline',
                'style': 'color: lightgray',
            }
        })}}
    </td>
{% endblock %}

{% block javascripts %}
    <script>
        {# Activer les tooltips #}
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
{% endblock %}
